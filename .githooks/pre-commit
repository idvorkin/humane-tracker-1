#!/bin/bash
# Pre-commit hook that runs:
# 1. Beads sync (if beads is configured)
# 2. Pre-commit framework (lint, format, TypeScript check)
# 3. Unit tests (vitest)

set -e

echo "ğŸ” Running pre-commit checks..."

# 1. Flush pending beads changes before commit
if command -v bd &> /dev/null && [ -d ".beads" ]; then
    echo "ğŸ“¦ Syncing beads..."
    bd sync --quiet 2>/dev/null || true
fi

# 2. Run pre-commit framework (biome, prettier, typescript)
if command -v pre-commit &> /dev/null; then
    echo "ğŸ§¹ Running linters, formatters, and type check..."
    # Use --hook-stage and point to config to bypass core.hooksPath conflict
    pre-commit run --config .pre-commit-config.yaml || exit 1
else
    echo "âš ï¸  pre-commit not installed, skipping lint checks"
    echo "   Install with: pip install pre-commit"
fi

# 3. Run TypeScript type check (catches errors that vitest misses)
echo "ğŸ“ Running TypeScript type check..."
cd humane-tracker && npx tsc --noEmit || exit 1

# 4. Run unit tests
echo "ğŸ§ª Running unit tests..."
npm run test-called-from-just -- --run --reporter=dot || exit 1
cd ..

echo "âœ… All pre-commit checks passed!"
