#!/usr/bin/env node
// Serve Playwright report over HTTPS for trace viewer compatibility
import { createServer } from "https";
import { createServer as createHttpServer } from "http";
import handler from "serve-handler";
import { readFileSync, existsSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";
import { execSync } from "child_process";

const __dirname = dirname(fileURLToPath(import.meta.url));
const PORT = 9323;

// Get Tailscale hostname
function getTailscaleHostname() {
	try {
		const json = execSync("tailscale status --json 2>/dev/null", {
			encoding: "utf-8",
		});
		const status = JSON.parse(json);
		const fullName = status.Self?.DNSName?.replace(/\.$/, "");
		return fullName ? fullName.split(".")[0] : null;
	} catch {
		return null;
	}
}

// Check if we're in a container
const isContainer =
	existsSync("/.dockerenv") || process.env.container !== undefined;
const hostname = getTailscaleHostname();

// Use self-signed cert for HTTPS (required for service workers)
// These are generated by @vitejs/plugin-basic-ssl
const certPath = join(__dirname, "node_modules", ".vite", "basic-ssl", "_cert.pem");
const keyPath = join(__dirname, "node_modules", ".vite", "basic-ssl", "_cert.pem"); // basic-ssl uses same file for both

const reportDir = join(__dirname, "playwright-report");

// Try to use existing Vite SSL certs, fallback to HTTP with warning
let useHttps = false;
let server;

if (existsSync(certPath) && existsSync(keyPath)) {
	const options = {
		key: readFileSync(keyPath),
		cert: readFileSync(certPath),
	};

	server = createServer(options, (request, response) => {
		return handler(request, response, {
			public: reportDir,
			cleanUrls: false,
		});
	});
	useHttps = true;
} else {
	console.warn("⚠️  SSL certificates not found - falling back to HTTP");
	console.warn(
		"   Run 'just dev' once to generate certs, then restart this server",
	);
	server = createHttpServer((request, response) => {
		return handler(request, response, {
			public: reportDir,
			cleanUrls: false,
		});
	});
}

server.listen(PORT, "0.0.0.0", () => {
	const protocol = useHttps ? "https" : "http";
	console.log(`\nStarting Playwright report viewer...`);
	console.log(`  Local:     ${protocol}://localhost:${PORT}`);
	if (isContainer && hostname) {
		console.log(`  Container: ${protocol}://${hostname}:${PORT}`);
	}
	if (useHttps) {
		console.log(`  ✅ HTTPS enabled - trace viewer will work`);
	} else {
		console.log(`  ⚠️  HTTP only - trace viewer requires HTTPS or localhost`);
	}
	console.log(`\nPress Ctrl+C to stop the server\n`);
});
