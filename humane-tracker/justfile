# Justfile

default:
    @just --list

# Run the development server (generates version first)
dev: generate-version
    npm run dev

# Generate version info from git
generate-version:
    #!/usr/bin/env bash
    SHA=$(git rev-parse HEAD)
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    REPO_URL=$(git remote get-url origin | sed 's/\.git$//' | sed 's|git@github.com:|https://github.com/|' | sed 's|https://[^@]*@|https://|')
    COMMIT_URL="$REPO_URL/commit/$SHA"
    CURRENT_URL="$REPO_URL/tree/$BRANCH"
    BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    cat > src/generated_version.ts <<EOF
    // This file is auto-generated at build time by \`just generate-version\`
    // DO NOT EDIT manually - changes will be overwritten
    export const GIT_SHA = "$SHA";
    export const GIT_COMMIT_URL = "$COMMIT_URL";
    export const GIT_CURRENT_URL = "$CURRENT_URL";
    export const GIT_BRANCH = "$BRANCH";
    export const BUILD_TIMESTAMP = "$BUILD_TIME";
    EOF

# Build the project (generates version info first)
build: generate-version
    npm run build

# Run unit tests (generates version info first)
test: generate-version
    npm run test

# Run E2E tests (all projects - desktop chromium + mobile)
e2e:
    npx playwright test

# Run E2E tests (desktop chromium only)
e2e-desktop:
    npx playwright test --project=chromium

# Run E2E tests (mobile only)
e2e-mobile:
    npx playwright test --project=mobile

# View E2E test report in browser
# Serves Playwright HTML report over HTTPS with videos, screenshots, and traces
# HTTPS is required for trace viewer (service workers need secure context)
# Local access: https://localhost:9323
# Container (Tailscale): https://<container-hostname>:9323
e2e-report:
    #!/usr/bin/env bash
    HOSTNAME=$(hostname)
    echo "Starting Playwright report viewer with HTTPS..."
    echo "  Local:     https://localhost:9323"
    echo "  Container: https://$HOSTNAME:9323"
    echo "  âœ… HTTPS enabled - trace viewer will work"
    echo "Press Ctrl+C to stop the server"
    node serve-report-https.js

# Run E2E tests in interactive UI mode
e2e-ui:
    npx playwright test --ui

# Deploy to staging
deploy-stage: test build
    npx surge dist humane-tracker-stage.surge.sh

# Deploy to production
deploy-prod: test build
    npx surge dist humane-tracker.surge.sh
