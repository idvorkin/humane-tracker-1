# Justfile for humane-tracker

default:
    @just --list

# One-time setup after clone (run this first!)
setup:
    #!/usr/bin/env bash
    echo "ğŸ”§ Setting up development environment..."

    # Configure git hooks (from repo root)
    cd .. && git config core.hooksPath .githooks
    echo "âœ“ Git hooks configured (.githooks)"

    # Configure git to rebase on pull (avoids merge commits and history divergence)
    cd .. && git config pull.rebase true
    echo "âœ“ Git pull configured to rebase (avoids merge commits)"

    # Install npm dependencies
    npm install
    echo "âœ“ npm dependencies installed"

    echo ""
    echo "âœ… Setup complete! Run 'just dev' to start developing."
    echo ""
    echo "ğŸ“ Note: For Playwright, use a global install (shared across repos):"
    echo "   npm install -g playwright && playwright install --with-deps"

# Run the development server (generates version first)
dev: generate-version
    npm run dev-called-from-just

# Generate version info from git
generate-version:
    #!/usr/bin/env bash
    SHA=$(git rev-parse HEAD)
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    REPO_URL=$(git remote get-url origin | sed 's/\.git$//' | sed 's|git@github.com:|https://github.com/|' | sed 's|https://[^@]*@|https://|')
    COMMIT_URL="$REPO_URL/commit/$SHA"
    CURRENT_URL="$REPO_URL/tree/$BRANCH"
    BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    cat > src/generated_version.ts <<EOF
    // This file is auto-generated at build time by \`just generate-version\`
    // DO NOT EDIT manually - changes will be overwritten
    export const GIT_SHA = "$SHA";
    export const GIT_COMMIT_URL = "$COMMIT_URL";
    export const GIT_CURRENT_URL = "$CURRENT_URL";
    export const GIT_BRANCH = "$BRANCH";
    export const BUILD_TIMESTAMP = "$BUILD_TIME";
    EOF

# Build the project (generates version info first)
build: generate-version
    npm run build-called-from-just

# Run unit tests (depends on build)
test: build
    npm run test-called-from-just

# Run E2E tests (mobile only - fast default)
e2e:
    npx playwright test --project=mobile

# Run E2E tests (all projects - desktop chromium + mobile)
e2e-all:
    npx playwright test

# Run fast E2E tests (quick smoke tests) - good for CI
e2e-fast:
    npx playwright test habit-tracking.spec.ts load-default-habits.spec.ts

# Run E2E tests (desktop chromium only)
e2e-desktop:
    npx playwright test --project=chromium

# Run E2E tests (mobile only) - alias for e2e
e2e-mobile:
    npx playwright test --project=mobile

# Run E2E tests in interactive UI mode
e2e-ui:
    npx playwright test --ui

# Run E2E tests in headed mode (see browser)
e2e-headed:
    npx playwright test --headed

# Run E2E tests in debug mode (step-through)
e2e-debug:
    npx playwright test --debug

# View E2E test report in browser
# Serves Playwright HTML report with videos, screenshots, and traces
e2e-report:
    #!/usr/bin/env bash
    HOSTNAME=$(hostname)
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         Playwright E2E Test Report Server                         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ“Š Report Access:"
    echo "   Local:     http://localhost:9323"
    echo "   Tailscale: http://$HOSTNAME:9323"
    echo ""
    echo "ğŸ¬ Viewing Trace Files (requires HTTPS or localhost):"
    echo ""
    echo "   Option 1 (Recommended): Online Trace Viewer + Tailscale"
    echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "   1. Open report: http://$HOSTNAME:9323 (via Tailscale)"
    echo "   2. Click test â†’ Download .zip trace file"
    echo "   3. Go to: https://trace.playwright.dev/"
    echo "   4. Drag & drop .zip file (all local, no data sent)"
    echo ""
    echo "   Option 2: SSH Tunnel (for direct trace access)"
    echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "   ssh -L 9323:localhost:9323 developer@$HOSTNAME"
    echo "   Then open: http://localhost:9323"
    echo "   Click 'View trace' on any test - works! âœ…"
    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "Press Ctrl+C to stop the server"
    echo ""
    npx playwright show-report --host 0.0.0.0 --port 9323

# Install Playwright browsers
install-browsers:
    npx playwright install

# Deploy to staging
deploy-stage: test build
    npx surge dist humane-tracker-stage.surge.sh

# Deploy to production
deploy-prod: test build
    npx surge dist humane-tracker.surge.sh
